{
  "suite": "persist_replay",
  "cases": [
    {
      "name": "basic_replay_sequence",
      "now_ms": 1000,
      "records": [
        ["SET", "a", "1"],
        ["INCR", "a"],
        ["SET", "ttl", "x", "PX", "5"]
      ],
      "assertions": [
        { "key": "a", "expect": "2" },
        { "key": "ttl", "expect": "x", "at_ms": 1002 },
        { "key": "ttl", "expect": null, "at_ms": 1006 }
      ]
    },
    {
      "name": "delete_persists",
      "now_ms": 2000,
      "records": [
        ["SET", "k", "v"],
        ["DEL", "k"]
      ],
      "assertions": [
        { "key": "k", "expect": null }
      ]
    },
    {
      "name": "ttl_overwrite_and_persist_chain",
      "now_ms": 4000,
      "records": [
        ["SET", "ttl:key", "seed"],
        ["PEXPIRE", "ttl:key", "25"],
        ["SET", "ttl:key", "overwrite"],
        ["PEXPIRE", "ttl:key", "5"],
        ["PERSIST", "ttl:key"],
        ["APPEND", "ttl:key", "-tail"]
      ],
      "assertions": [
        { "key": "ttl:key", "expect": "overwrite-tail", "at_ms": 4000 },
        { "key": "ttl:key", "expect": "overwrite-tail", "at_ms": 4010 },
        { "key": "ttl:key", "expect": "overwrite-tail", "at_ms": 4100 }
      ]
    },
    {
      "name": "rename_and_recreate_source_ordering",
      "now_ms": 5000,
      "records": [
        ["SET", "rename:src", "v1"],
        ["RENAME", "rename:src", "rename:dst"],
        ["SET", "rename:src", "v2"],
        ["DEL", "rename:dst"],
        ["SET", "rename:dst", "v3"]
      ],
      "assertions": [
        { "key": "rename:src", "expect": "v2" },
        { "key": "rename:dst", "expect": "v3" }
      ]
    },
    {
      "name": "mset_incr_getset_chain",
      "now_ms": 6000,
      "records": [
        ["MSET", "chain:a", "1", "chain:b", "x"],
        ["INCRBY", "chain:a", "9"],
        ["GETSET", "chain:a", "5"],
        ["INCR", "chain:a"],
        ["APPEND", "chain:b", "y"]
      ],
      "assertions": [
        { "key": "chain:a", "expect": "6" },
        { "key": "chain:b", "expect": "xy" }
      ]
    },
    {
      "name": "expiration_boundary_and_recreate_order",
      "now_ms": 7000,
      "records": [
        ["SET", "exp:key", "live"],
        ["PEXPIRE", "exp:key", "3"],
        ["SET", "exp:survivor", "s"],
        ["DEL", "exp:key"],
        ["SET", "exp:key", "reborn"],
        ["PEXPIRE", "exp:key", "2"]
      ],
      "assertions": [
        { "key": "exp:key", "expect": "reborn", "at_ms": 7001 },
        { "key": "exp:key", "expect": null, "at_ms": 7004 },
        { "key": "exp:survivor", "expect": "s", "at_ms": 7005 }
      ]
    },
    {
      "name": "setex_psetex_persist_interleave",
      "now_ms": 8000,
      "records": [
        ["SETEX", "sx:key", "1", "short"],
        ["PSETEX", "psx:key", "5", "mini"],
        ["PERSIST", "psx:key"],
        ["SET", "sx:key", "long"]
      ],
      "assertions": [
        { "key": "sx:key", "expect": "long", "at_ms": 8500 },
        { "key": "psx:key", "expect": "mini", "at_ms": 9000 }
      ]
    },
    {
      "name": "setnx_idempotent_replay",
      "now_ms": 9000,
      "records": [
        ["SET", "nx:key", "first"],
        ["SETNX", "nx:key", "second"],
        ["SETNX", "nx:new", "created"]
      ],
      "assertions": [
        { "key": "nx:key", "expect": "first" },
        { "key": "nx:new", "expect": "created" }
      ]
    },
    {
      "name": "decrby_and_incrbyfloat_replay",
      "now_ms": 10000,
      "records": [
        ["SET", "counter", "100"],
        ["DECRBY", "counter", "30"],
        ["DECRBY", "counter", "20"],
        ["INCR", "counter"]
      ],
      "assertions": [
        { "key": "counter", "expect": "51" }
      ]
    },
    {
      "name": "setrange_replay",
      "now_ms": 11000,
      "records": [
        ["SET", "buf", "Hello World"],
        ["SETRANGE", "buf", "6", "Redis"]
      ],
      "assertions": [
        { "key": "buf", "expect": "Hello Redis" }
      ]
    },
    {
      "name": "getdel_replay",
      "now_ms": 12000,
      "records": [
        ["SET", "gd:key", "ephemeral"],
        ["GETDEL", "gd:key"],
        ["SET", "gd:survivor", "alive"]
      ],
      "assertions": [
        { "key": "gd:key", "expect": null },
        { "key": "gd:survivor", "expect": "alive" }
      ]
    },
    {
      "name": "multi_key_overwrite_chain",
      "now_ms": 13000,
      "records": [
        ["MSET", "mk:a", "1", "mk:b", "2", "mk:c", "3"],
        ["SET", "mk:a", "10"],
        ["APPEND", "mk:b", "0"],
        ["DEL", "mk:c"],
        ["SET", "mk:c", "30"]
      ],
      "assertions": [
        { "key": "mk:a", "expect": "10" },
        { "key": "mk:b", "expect": "20" },
        { "key": "mk:c", "expect": "30" }
      ]
    },
    {
      "name": "set_ex_seconds_ttl_replay",
      "now_ms": 14000,
      "records": [
        ["SET", "ex:key", "val", "EX", "1"]
      ],
      "assertions": [
        { "key": "ex:key", "expect": "val", "at_ms": 14500 },
        { "key": "ex:key", "expect": null, "at_ms": 15001 }
      ]
    },
    {
      "name": "set_nx_xx_flags_replay",
      "now_ms": 15000,
      "records": [
        ["SET", "flag:key", "original"],
        ["SET", "flag:key", "overwrite", "NX"],
        ["SET", "flag:key", "updated", "XX"],
        ["SET", "flag:new", "attempt", "XX"]
      ],
      "assertions": [
        { "key": "flag:key", "expect": "updated" },
        { "key": "flag:new", "expect": null }
      ]
    },
    {
      "name": "msetnx_atomicity_replay",
      "now_ms": 16000,
      "records": [
        ["SET", "mnx:exist", "old"],
        ["MSETNX", "mnx:exist", "new", "mnx:fresh", "val"]
      ],
      "assertions": [
        { "key": "mnx:exist", "expect": "old" },
        { "key": "mnx:fresh", "expect": null }
      ]
    },
    {
      "name": "getex_with_persist_replay",
      "now_ms": 17000,
      "records": [
        ["SET", "gx:key", "data", "PX", "10"],
        ["GETEX", "gx:key", "PERSIST"]
      ],
      "assertions": [
        { "key": "gx:key", "expect": "data", "at_ms": 17005 },
        { "key": "gx:key", "expect": "data", "at_ms": 18000 }
      ]
    }
  ]
}
